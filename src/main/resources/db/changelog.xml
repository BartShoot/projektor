<?xml version="1.0" encoding="UTF-8"?>

<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-latest.xsd">

    <changeSet author="bartshoot" id="init database model">
        <createSequence incrementBy="50" sequenceName="cinemas_seq" startValue="1"/>
        <createTable tableName="cinemas">
            <column autoIncrement="true" name="id" type="INTEGER">
                <constraints nullable="false" primaryKey="true" primaryKeyName="cinemasPK"/>
            </column>
            <column name="cinema_chain" type="SMALLINT"/>
            <column name="location" type="VARCHAR(255)"/>
            <column name="name" type="VARCHAR(255)"/>
            <column name="city_id" type="INTEGER"/>
        </createTable>

        <createSequence incrementBy="50" sequenceName="cities_seq" startValue="1"/>
        <createTable tableName="cities">
            <column autoIncrement="true" name="id" type="INTEGER">
                <constraints nullable="false" primaryKey="true" primaryKeyName="citiesPK"/>
            </column>
            <column name="name" type="VARCHAR(255)"/>
        </createTable>

        <createSequence incrementBy="50" sequenceName="movies_seq" startValue="1"/>
        <createTable tableName="movies">
            <column autoIncrement="true" name="id" type="INTEGER">
                <constraints nullable="false" primaryKey="true" primaryKeyName="moviesPK"/>
            </column>
            <column name="duration_minutes" type="INTEGER"/>
            <column name="title" type="VARCHAR(255)"/>
        </createTable>

        <createSequence incrementBy="50" sequenceName="showings_seq" startValue="1"/>
        <createTable tableName="showings">
            <column autoIncrement="true" name="id" type="INTEGER">
                <constraints nullable="false" primaryKey="true" primaryKeyName="showingsPK"/>
            </column>
            <column name="showing_time" type="TIMESTAMP(6) WITHOUT TIME ZONE"/>
            <column name="cinema_id" type="INTEGER"/>
            <column name="movie_id" type="INTEGER"/>
        </createTable>

        <addForeignKeyConstraint baseColumnNames="movie_id" baseTableName="showings"
                                 constraintName="FK4jdrys6tdhcsfspbtw6kvo4h9" deferrable="false"
                                 initiallyDeferred="false" referencedColumnNames="id" referencedTableName="movies"
                                 validate="true"/>
        <addForeignKeyConstraint baseColumnNames="cinema_id" baseTableName="showings"
                                 constraintName="FK6latwj93msye2nu98toacjfy" deferrable="false"
                                 initiallyDeferred="false" referencedColumnNames="id" referencedTableName="cinemas"
                                 validate="true"/>
        <addForeignKeyConstraint baseColumnNames="city_id" baseTableName="cinemas"
                                 constraintName="FKd5qi30k4wfq2j9icy5mmsix1d" deferrable="false"
                                 initiallyDeferred="false" referencedColumnNames="id" referencedTableName="cities"
                                 validate="true"/>
    </changeSet>

    <changeSet author="gemini" id="add original_title to movies">
        <addColumn tableName="movies">
            <column name="original_title" type="VARCHAR(255)"/>
        </addColumn>
    </changeSet>

    <changeSet author="gemini" id="add external_id to cinemas">
        <addColumn tableName="cinemas">
            <column name="external_id" type="VARCHAR(255)"/>
        </addColumn>
    </changeSet>


    <changeSet author="bartshoot" id="add external ids and normalized title">
        <addColumn tableName="movies">
            <column name="cinema_city_id" type="VARCHAR(255)"/>
        </addColumn>
        <addColumn tableName="movies">
            <column name="helios_id" type="INTEGER"/>
        </addColumn>
        <addColumn tableName="movies">
            <column name="multikino_id" type="VARCHAR(255)"/>
        </addColumn>
        <addColumn tableName="movies">
            <column name="normalized_title" type="VARCHAR(255)"/>
        </addColumn>
    </changeSet>

    <changeSet author="bartshoot" id="add unique constraint">
        <addUniqueConstraint columnNames="cinema_city_id" constraintName="UC_MOVIESCINEMA_CITY_ID_COL"
                             tableName="movies"/>
        <addUniqueConstraint columnNames="helios_id" constraintName="UC_MOVIESHELIOS_ID_COL" tableName="movies"/>
        <addUniqueConstraint columnNames="multikino_id" constraintName="UC_MOVIESMULTIKINO_ID_COL" tableName="movies"/>
        <addUniqueConstraint columnNames="normalized_title" constraintName="UC_MOVIESNORMALIZED_TITLE_COL"
                             tableName="movies"/>
    </changeSet>

    <changeSet author="bartshoot" id="add external id for showing">
        <addColumn tableName="showings">
            <column name="external_id" type="VARCHAR(255)"/>
        </addColumn>
    </changeSet>

    <changeSet author="bartshoot" id="add indexes">
        <createIndex indexName="idx_showing_cinema_time" tableName="showings">
            <column name="cinema_id"/>
            <column name="showing_time"/>
        </createIndex>
        <createIndex indexName="idx_showing_movie_time" tableName="showings">
            <column name="movie_id"/>
            <column name="showing_time"/>
        </createIndex>
    </changeSet>

    <changeSet author="bartshoot" id="add durable_jobs table">
        <createSequence incrementBy="50" sequenceName="jobs_seq" startValue="1"/>
        <createTable tableName="jobs">
            <column autoIncrement="true" name="id" type="INTEGER">
                <constraints nullable="false" primaryKey="true" primaryKeyName="jobsPK"/>
            </column>
            <column name="cinema_chain" type="SMALLINT"/>
            <column name="cinema_id" type="VARCHAR(255)"/>
            <column name="city_id" type="INTEGER"/>
            <column name="create_date" type="TIMESTAMP(6) WITHOUT TIME ZONE"/>
            <column name="last_update_date" type="TIMESTAMP(6) WITHOUT TIME ZONE"/>
            <column name="movie_id" type="INTEGER"/>
            <column name="status" type="SMALLINT"/>
            <column name="type" type="SMALLINT"/>
        </createTable>
    </changeSet>

    <changeSet author="bartshoot" id="add durable_jobs results">
        <addColumn tableName="jobs">
            <column name="result" type="VARCHAR(255)"/>
        </addColumn>
    </changeSet>
</databaseChangeLog>